@model MrCMS.Web.Apps.Ecommerce.Payment.Braintree.Models.BraintreePaymentDetailsModel
@{
    var token = ViewData["token"] as string;
    var expiryMonths = ViewData["expiry-months"] as IEnumerable<SelectListItem>;
    var expiryYears = ViewData["expiry-years"] as IEnumerable<SelectListItem>;
}
<div class="alert alert-danger" role="alert" data-braintree-errors="true" style="display: none;"></div>

<div class="row">
    <div class="col-sm-8">
        @using (Html.BeginForm("MakePayment", "Braintree", FormMethod.Post, new { id = "braintree-checkout" }))
        {
            @Html.HiddenFor(x => x.TotalToPay)

            <div class="form-group">
                @Html.LabelFor(x => x.CardNumber)
                @Html.TextBoxFor(x => x.CardNumber, new { @class = "form-control", data_braintree_name = "number" })
                @Html.ValidationMessageFor(x => x.CardNumber)
            </div>

            <div class="form-group">
                @Html.LabelFor(x => x.CardholderName)
                @Html.TextBoxFor(x => x.CardholderName, new { @class = "form-control", data_braintree_name = "cardholder_name" })
                @Html.ValidationMessageFor(x => x.CardholderName)
            </div>

            <div class="form-group">
                @Html.LabelFor(x => x.CVV)
                @Html.TextBoxFor(x => x.CVV, new { @class = "form-control", data_braintree_name = "cvv" })
                @Html.ValidationMessageFor(x => x.CVV)
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(x => x.ExpirationMonth)
                        @Html.DropDownListFor(x => x.ExpirationMonth, expiryMonths, new { @class = "form-control", data_braintree_name = "expiration_month" })
                        @Html.ValidationMessageFor(x => x.ExpirationMonth)
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(x => x.ExpirationYear)
                        @Html.DropDownListFor(x => x.ExpirationYear, expiryYears, new { @class = "form-control", data_braintree_name = "expiration_year" })
                        @Html.ValidationMessageFor(x => x.ExpirationYear)
                    </div>
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(x => x.PostalCode)
                @Html.TextBoxFor(x => x.PostalCode, new { @class = "form-control", data_braintree_name = "postal_code" })
                @Html.ValidationMessageFor(x => x.PostalCode)
            </div>

            <input type="submit" value="@Resource("Confirm Order")" class="btn btn-primary btn-lg" data-submit-button="true">
        }
    </div>
</div>

<script type="text/javascript">
    (function ($) {
        var client = new braintree.api.Client({ clientToken: "@token" });

        $(function () {
            $('#braintree-checkout').on('submit', check3DSecure);
        });

        function check3DSecure(event) {
            event.preventDefault();
            var form = $(event.target);
            var errorArea = $('[data-braintree-errors]');
            var submitButton = form.find('[data-submit-button]');

            errorArea.hide();
            disablePaymentButton(submitButton);

            client.verify3DS({
                amount: form.find('#TotalToPay').val(),
                creditCard: {
                    number: form.find('[data-braintree-name="number"]').val(),
                    cardholderName: form.find('[data-braintree-name="cardholder_name"]').val(),
                    expirationMonth: form.find('[data-braintree-name="expiration_month"]').val(),
                    expirationYear: form.find('[data-braintree-name="expiration_year"]').val(),
                    cvv: form.find('[data-braintree-name="cvv"]').val(),
                    billingAddress: {
                        postalCode: form.find('[data-braintree-name="postal_code"]').val()
                    }
                }
            }, function (error, response) {
                if (!error) {
                    postToUrl("/Apps/Ecommerce/Confirm/BraintreePayment", {
                        nonce: response.nonce,
                        liabilityShifted : response.verificationDetails.liabilityShifted,
                        liabilityShiftPossible: response.verificationDetails.liabilityShiftPossible
                    });
                }
                else {
                    enablePaymentButton(submitButton);
                    errorArea.empty();
                    errorArea.show();
                    errorArea.append(error.message);
                }
            });

            function postToUrl(path, params) {
                var tempForm = document.createElement("form");
                tempForm.setAttribute("method", "post");
                tempForm.setAttribute("action", path);

                for (var key in params) {
                    var hiddenField = document.createElement("input");
                    hiddenField.setAttribute("type", "hidden");
                    hiddenField.setAttribute("name", key);
                    hiddenField.setAttribute("value", params[key]);
                    tempForm.appendChild(hiddenField);
                }
                document.body.appendChild(tempForm);
                tempForm.submit();
            }
        }

        function disablePaymentButton(submitButton) {
            submitButton.attr('disabled', 'disabled');
            submitButton.val("Processing");
        }

        function enablePaymentButton(submitButton) {
            submitButton.removeAttr('disabled');
            submitButton.val("Confirm Order");
        }

    })(jQuery);
</script>